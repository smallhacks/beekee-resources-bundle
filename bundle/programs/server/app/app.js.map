{"version":3,"sources":["meteor://ðŸ’»app/lib/app_loader.js","meteor://ðŸ’»app/imports/api/authors.js","meteor://ðŸ’»app/imports/api/categories.js","meteor://ðŸ’»app/imports/api/codes.js","meteor://ðŸ’»app/imports/api/files.js","meteor://ðŸ’»app/imports/api/posts.js","meteor://ðŸ’»app/imports/api/spaces.js","meteor://ðŸ’»app/server/fixtures.js","meteor://ðŸ’»app/server/permissions.js","meteor://ðŸ’»app/server/publications.js","meteor://ðŸ’»app/server/uploads.js","meteor://ðŸ’»app/server/main.js"],"names":["Meteor","isServer","Inject","rawHead","rawBody","Assets","getText","isClient","startup","setTimeout","$","fadeOut","remove","module","export","Authors","Mongo","link","v","Posts","Collection","allow","insert","update","publish","spaceId","find","methods","authorInsert","name","nRefs","error","console","log","message","authorEdit","oldName","newName","author","findOne","_id","$set","multi","Categories","categoryInsert","type","categoryEdit","category","categoryDelete","$unset","Codes","Files","fileId","fs","Npm","require","rimraf","uploadDir","settings","deleteFile","post","err","unlinkSync","filePath","Spaces","Counts","PinnedCounts","FilesCounts","ImagesCounts","LiveFeedCounts","postId","check","String","sort","submitted","filters","skip","limit","self","liveFeedCounts","initializing","handle","observeChanges","added","doc","idx","changed","count","removed","ready","onStop","stop","after","userId","fileExt","call","$inc","addLikeComment","data","currentPostId","currentCommentId","$push","removeLikeComment","$pull","homePostInsert","postAttributes","_","extend","Date","now","order","space","postInsert","clientIP","connection","clientAddress","ownsDocument","isAdmin","users","spacesId","getSpaceId","spaceCode","updateCode","oldCode","newCode","codeId","code","deleteSpace","deleteSpaces","spaceInsert","spaceAttributes","title","lang","nbOfCodes","prefix","public","codeLength","makeCode","Accounts","visible","codePanel","createUserAllowed","liveFeed","lessons","resources","liveFeedComments","permissions","liveFeedAddPost","liveFeedAddCategory","body","length","text","possible","i","charAt","Math","floor","random","Roles","createRole","unlessExists","adminPassword","username","roles","each","user","id","createUser","email","password","profile","addUsersToRoles","userIsInRole","UploadServer","init","tmpDir","checkCreateDirectories","getDirectory","fileInfo","formData","newID","ObjectID","_str","finished","formFields","fileName","substr","lastIndexOf","toLowerCase","gm","path","autoOrient","resize","write","bindEnvironment","result","errorMessage","cmd","wrapAsync","exec","res","maxBuffer","res2","updateDir","getFileName","cacheTime","roleAssignment"],"mappings":"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EAAE,OAJO;AAKjBC,WAAO,EAAC;AAAC7I,UAAI,EAAC;AAAN;AALS,GAApB;AAOA,C;;;;;;;;;;;ACzCD;AACAuF,YAAY,GAAG,UAASvB,MAAT,EAAiBT,GAAjB,EAAsB;AACnC,SAAOA,GAAG,IAAIA,GAAG,CAACS,MAAJ,KAAeA,MAA7B;AACD,CAFD,C,CAIA;;;AACAwB,OAAO,GAAG,UAASxB,MAAT,EAAiB;AACzB,SAAOiE,KAAK,CAACc,YAAN,CAAmB5K,MAAM,CAACqK,IAAP,EAAnB,EAAkC,OAAlC,CAAP;AACD,CAFD,C;;;;;;;;;;;ACNA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AACA;AAGA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA,M;;;;;;;;;;;ACvQA,IAAIlH,KAAJ;AAAUtC,MAAM,CAACI,IAAP,CAAY,yBAAZ,EAAsC;AAACkC,OAAK,CAACjC,CAAD,EAAG;AAACiC,SAAK,GAACjC,CAAN;AAAQ;;AAAlB,CAAtC,EAA0D,CAA1D;AAEV;AAEAlB,MAAM,CAACQ,OAAP,CAAe,YAAY;AAE1BqK,cAAY,CAACC,IAAb,CAAkB;AACjBC,UAAM,EAAE/K,MAAM,CAAC0D,QAAP,CAAgBD,SAAhB,GAA0B,MADjB;AAEjBA,aAAS,EAAEzD,MAAM,CAAC0D,QAAP,CAAgBD,SAFV;AAGjBuH,0BAAsB,EAAE,IAHP;AAIjBC,gBAAY,EAAE,UAASC,QAAT,EAAmBC,QAAnB,EAA6B;AAE1C,UAAI1J,OAAO,GAAG0J,QAAQ,CAAC1J,OAAvB;AACAyJ,cAAQ,CAACzJ,OAAT,GAAmBA,OAAnB;AAEA,UAAI2J,KAAK,GAAG,IAAIpK,KAAK,CAACqK,QAAV,EAAZ,CAL0C,CAKR;;AAClC,UAAIjI,MAAM,GAAGgI,KAAK,CAACE,IAAnB;AACAJ,cAAQ,CAAC9H,MAAT,GAAkBA,MAAlB;;AAEA,UAAI+H,QAAQ,CAACtI,IAAT,IAAiB,UAArB,EAAiC;AAChCb,eAAO,CAACC,GAAR,CAAY,8BAAZ;AACA,eAAO,MAAIR,OAAJ,GAAY,YAAnB;AACA,OAHD,MAIK,IAAI0J,QAAQ,CAACtI,IAAT,IAAiB,UAArB,EAAiC;AACrCb,eAAO,CAACC,GAAR,CAAY,yBAAZ;AACA,eAAO,MAAIR,OAAJ,GAAY,YAAnB;AACA,OAHI,MAIA,IAAI0J,QAAQ,CAACtI,IAAT,IAAiB,QAArB,EAA+B;AACnCb,eAAO,CAACC,GAAR,CAAY,0BAAZ;AACA,eAAO,MAAIR,OAAJ,GAAY,UAAZ,GAAuB2B,MAA9B;AACA,OAHI,CAIL;AAJK,WAKA,IAAI+H,QAAQ,CAACtI,IAAT,IAAiB,QAArB,EAA+B;AACnCb,iBAAO,CAACC,GAAR,CAAY,uBAAZ;AACA,iBAAO,UAAP;AACA;;AACD,aAAO,GAAP;AAEA,KAhCgB;AAiCjBsJ,YAAQ,EAAE,UAASL,QAAT,EAAmBM,UAAnB,EAA+BL,QAA/B,EAAyC;AAElD,UAAIM,QAAQ,GAAGP,QAAQ,CAACrJ,IAAT,CAAc6J,MAAd,CAAqB,CAArB,EAAwBR,QAAQ,CAACrJ,IAAT,CAAc8J,WAAd,CAA0B,GAA1B,CAAxB,KAA2DT,QAAQ,CAACrJ,IAAnF;AACAqJ,cAAQ,CAACO,QAAT,GAAoBA,QAApB,CAHkD,CAIlD;;AAEA,UAAI3F,OAAO,GAAGoF,QAAQ,CAACrJ,IAAT,CAAc6J,MAAd,CAAqBR,QAAQ,CAACrJ,IAAT,CAAc8J,WAAd,CAA0B,GAA1B,IAA+B,CAApD,EAAuDC,WAAvD,EAAd;AACAV,cAAQ,CAACpF,OAAT,GAAmBA,OAAnB;;AAEA,UAAI0F,UAAU,CAAC3I,IAAX,IAAmB,UAAnB,IAAiC2I,UAAU,CAAC3I,IAAX,IAAmB,UAAxD,EAAoE;AACnE,YAAIiD,OAAO,IAAI,KAAX,IAAoBA,OAAO,IAAI,MAA/B,IAAyCA,OAAO,IAAI,KAAxD,EAA+D;AAC9D;AACA+F,YAAE,CAAC7L,MAAM,CAAC0D,QAAP,CAAgBD,SAAhB,GAA0ByH,QAAQ,CAACY,IAApC,CAAF,CAA4CC,UAA5C,GAAyDC,MAAzD,CAAgE,MAAhE,EAAuE,MAAvE,EAA+EC,KAA/E,CAAqFjM,MAAM,CAAC0D,QAAP,CAAgBD,SAAhB,GAA0ByH,QAAQ,CAACY,IAAxH,EAA6H9L,MAAM,CAACkM,eAAP,CAAuB,UAAUnK,KAAV,EAAiBoK,MAAjB,EAAyB;AAC5K,gBAAIpK,KAAJ,EAAW;AACVC,qBAAO,CAACC,GAAR,CAAY,0BAAwBF,KAApC;AACA,kBAAIqK,YAAY,GAAG,uBAAnB;AACAjJ,mBAAK,CAAC7B,MAAN,CAAa;AAACkB,mBAAG,EAAE0I,QAAQ,CAAC9H,MAAf;AAAuBrB,qBAAK,EAACqK;AAA7B,eAAb;AACA,aAJD,MAIO;AACNjJ,mBAAK,CAAC7B,MAAN,CAAa;AAACkB,mBAAG,EAAE0I,QAAQ,CAAC9H,MAAf;AAAuBqI,wBAAQ,EAACP,QAAQ,CAACO,QAAzC;AAAmD3F,uBAAO,EAACA,OAA3D;AAAoE/B,wBAAQ,EAAEmH,QAAQ,CAACY;AAAvF,eAAb;AACA;AACD,WAR4H,CAA7H;AASA,SAXD,MAYK;AACJ3I,eAAK,CAAC7B,MAAN,CAAa;AAACkB,eAAG,EAAE0I,QAAQ,CAAC9H,MAAf;AAAuBqI,oBAAQ,EAACP,QAAQ,CAACO,QAAzC;AAAmD3F,mBAAO,EAACA,OAA3D;AAAoE/B,oBAAQ,EAAEmH,QAAQ,CAACY;AAAvF,WAAb;AACA;AACD,OAhBD,MAiBK,IAAIN,UAAU,CAAC3I,IAAX,IAAmB,QAAvB,EAAiC;AACrCwJ,WAAG,GAAGrM,MAAM,CAACsM,SAAP,CAAiBC,IAAjB,CAAN;AACAC,WAAG,GAAGH,GAAG,CAAC,YAAUrM,MAAM,CAAC0D,QAAP,CAAgBD,SAA1B,GAAoCyH,QAAQ,CAACY,IAA7C,GAAkD,QAAlD,GAA2D9L,MAAM,CAAC0D,QAAP,CAAgBD,SAA3E,GAAqF,GAArF,GAAyFyH,QAAQ,CAACzJ,OAAlG,GAA0G,UAA1G,GAAqHyJ,QAAQ,CAAC9H,MAA9H,GAAqI,GAAtI,EAA2I;AAACqJ,mBAAS,EAAG,OAAO,IAAP,GAAc;AAA3B,SAA3I,EAA2K,UAAS1K,KAAT,EAAeoK,MAAf,EAAsB;AACzM,cAAIpK,KAAJ,EAAW;AACVC,mBAAO,CAACC,GAAR,CAAY,qCAAmCF,KAA/C;AACA,gBAAIqK,YAAY,GAAG,uBAAnB;AACAjJ,iBAAK,CAAC7B,MAAN,CAAa;AAACkB,iBAAG,EAAE0I,QAAQ,CAAC9H,MAAf;AAAuBrB,mBAAK,EAACqK;AAA7B,aAAb;AACA,WAJD,MAIO;AACNjJ,iBAAK,CAAC7B,MAAN,CAAa;AAACkB,iBAAG,EAAE0I,QAAQ,CAAC9H,MAAf;AAAuBqI,sBAAQ,EAACP,QAAQ,CAACO,QAAzC;AAAmD3F,qBAAO,EAACA,OAA3D;AAAoE/B,sBAAQ,EAAEmH,QAAQ,CAACY;AAAvF,aAAb;AACA;AACD,SARQ,CAAT;AASAY,YAAI,GAAGL,GAAG,CAAC,SAAOrM,MAAM,CAAC0D,QAAP,CAAgBD,SAAvB,GAAiCyH,QAAQ,CAACY,IAA1C,GAA+C,GAAhD,CAAV;AACA,OAZI,MAaA,IAAIN,UAAU,CAAC3I,IAAX,IAAmB,QAAvB,EAAiC;AACrCwJ,WAAG,GAAGrM,MAAM,CAACsM,SAAP,CAAiBC,IAAjB,CAAN;AACAC,WAAG,GAAGH,GAAG,CAAC,eAAarM,MAAM,CAAC0D,QAAP,CAAgBD,SAA7B,GAAuCyH,QAAQ,CAACY,IAAhD,GAAqD,OAArD,GAA6D9L,MAAM,CAAC0D,QAAP,CAAgBiJ,SAA9E,EAAyF;AAACF,mBAAS,EAAG,OAAO,IAAP,GAAc;AAA3B,SAAzF,EAAyH,UAAS1K,KAAT,EAAeoK,MAAf,EAAsB;AACvJ,cAAIpK,KAAJ,EAAW;AACVC,mBAAO,CAACC,GAAR,CAAY,sCAAoCF,KAAhD;AACA,gBAAIqK,YAAY,GAAG,uBAAnB;AACAjJ,iBAAK,CAAC7B,MAAN,CAAa;AAACkB,iBAAG,EAAE0I,QAAQ,CAAC9H,MAAf;AAAuBrB,mBAAK,EAACqK;AAA7B,aAAb;AACA,WAJD,MAIO;AACNjJ,iBAAK,CAAC7B,MAAN,CAAa;AAACkB,iBAAG,EAAE0I,QAAQ,CAAC9H,MAAf;AAAuBqI,sBAAQ,EAACP,QAAQ,CAACO,QAAzC;AAAmD3F,qBAAO,EAACA,OAA3D;AAAoE/B,sBAAQ,EAAEmH,QAAQ,CAACY;AAAvF,aAAb;AACA;AACD,SARQ,CAAT;AASAY,YAAI,GAAGL,GAAG,CAAC,SAAOrM,MAAM,CAAC0D,QAAP,CAAgBD,SAAvB,GAAiCyH,QAAQ,CAACY,IAA1C,GAA+C,GAAhD,EAAqD;AAACW,mBAAS,EAAG,OAAO,IAAP,GAAc;AAA3B,SAArD,CAAV;AACA;AACD,KArFgB;AAsFjBG,eAAW,EAAE,UAAS1B,QAAT,EAAmBM,UAAnB,EAA+BL,QAA/B,EAAyC;AAErD,UAAIM,QAAQ,GAAGP,QAAQ,CAACrJ,IAAxB,CAFqD,CAIrD;AACA;AACA;;AAEA,aAAO4J,QAAP,CARqD,CASrD;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA,KA7GgB;AA8GjBoB,aAAS,EAAE;AA9GM,GAAlB;AAgHA,CAlHD,E;;;;;;;;;;;ACJA,IAAI7M,MAAJ;AAAWa,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACjB,QAAM,CAACkB,CAAD,EAAG;AAAClB,UAAM,GAACkB,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqDL,MAAM,CAACI,IAAP,CAAY,uBAAZ;AAAqCJ,MAAM,CAACI,IAAP,CAAY,2BAAZ;AAAyCJ,MAAM,CAACI,IAAP,CAAY,sBAAZ;AAAoCJ,MAAM,CAACI,IAAP,CAAY,0BAAZ;AAAwCJ,MAAM,CAACI,IAAP,CAAY,sBAAZ;AAS1NjB,MAAM,CAACQ,OAAP,CAAe,MAAM;AAEpBR,QAAM,CAACwB,OAAP,CAAe,IAAf,EAAqB,YAAY;AAC7B,WAAOxB,MAAM,CAAC8M,cAAP,CAAsBpL,IAAtB,EAAP;AAEJ,GAHA,EAFoB,CAMnB;AAED;AACA;AACA;AACA;AACA;AACA;AACD;AAEA;AACA;AACA;AAEC,CApBD,E","file":"/app.js","sourcesContent":["if (Meteor.isServer) {\n\tInject.rawHead(\"metaLoader\", '<meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=0, width=device-width, height=device-height\"/><meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\t<meta name=\"mobile-web-app-capable\" content=\"yes\">');\n\n\tInject.rawBody(\"htmlLoader\", Assets.getText('app_loader.html'));\n}\n\nif (Meteor.isClient) {\n\tMeteor.startup(function() {\n\t\tsetTimeout(function() {\n\t\t\t$(\"#inject-loader-wrapper\").fadeOut(500, function() { $(this).remove(); });\n\t\t}, 700);\n\t});\n}","import { Mongo } from 'meteor/mongo';\n\nimport { Posts } from './posts.js';\n \nexport const Authors = new Mongo.Collection('resources-authors');\n\nAuthors.allow({\n\n\tinsert: function() {return true},\n\n\tremove: function() {return true},\n\n\tupdate: function() {return true}\n});\n\nif(Meteor.isServer) {\n\n\tMeteor.publish(\"authors\", function(spaceId) {\n\t\treturn Authors.find({spaceId: spaceId});\n\t});\n}\n\nMeteor.methods({\n\n\tauthorInsert: function(name, spaceId) {\n\t\tAuthors.insert({name: name, spaceId: spaceId, nRefs: 0},function(error) {\n\t\t\tif (error) {\n\t\t\t\tconsole.log(\"Error when inserting author  : \"+error.message);\n\t\t\t} else {\n\t\t\t\tconsole.log(\"Author inserted\");\n\t\t\t}\n\t\t});\n\t},\n\tauthorEdit: function(spaceId, oldName, newName) {\n\t\tvar author = Authors.findOne({name: oldName, spaceId: spaceId});\n\t\tAuthors.update(author._id, {$set: {name:newName}}, function(error) {\n\t\t\tif (error) {\n\t\t\t\tconsole.log(\"Error when changing author name : \"+error.message);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tPosts.update({spaceId:spaceId, author: oldName},{$set: {author: newName}}, {multi: true}); // Update all author posts with new name\n\t\t\t}\n\t\t});\n\t}\n});","import { Mongo } from 'meteor/mongo';\n\nimport { Posts } from './posts.js';\n \nexport const Categories = new Mongo.Collection('resources-categories');\n\nCategories.allow({\n\n\tinsert: function() {return true},\n\n\tremove: function() {return true},\n\n\tupdate: function() {return true}\n});\n\n\nif(Meteor.isServer) {\n\n\tMeteor.publish(\"categories\", function(spaceId) {\n\t\treturn Categories.find({spaceId: spaceId});\n\t});\n}\n\nMeteor.methods({\n\n\tcategoryInsert: function(type, name, spaceId) {\n\t\tCategories.insert({type: type, name: name, spaceId: spaceId, nRefs: 0});\n\t},\n\tcategoryEdit: function(spaceId, type, oldName, newName) {\n\t\tvar category = Categories.findOne({type: type, name: oldName, spaceId: spaceId});\n\t\tCategories.update(category._id, {$set: {name:newName}}, function(error) {\n\t\t\tif (error) {\n\t\t\t\tconsole.log(\"Error when changing category name : \"+error.message);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tPosts.update({spaceId:spaceId, type: type, category: oldName},{$set: {category: newName}}, {multi: true}); // Update all author posts with new name\n\t\t\t}\n\t\t});\n\t},\n\tcategoryDelete: function(type, name, spaceId) {\n\t\tvar category = Categories.findOne({type: type, name: name, spaceId: spaceId});\n\t\tCategories.remove(category._id, function(error) {\n\t\t\tif (error) {\n\t\t\t\tconsole.log(\"Error when deleting category : \"+error.message);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tPosts.update({type: type, spaceId:spaceId, category: name},{$unset: {category:\"\"}}, {multi: true}); // Update all author posts with new name\n\t\t\t}\n\t\t});\n\t}\n});","import { Mongo } from 'meteor/mongo';\n \nexport const Codes = new Mongo.Collection('resources-codes');\n\nCodes.allow({\n\n\tinsert: function() {return true},\n\n\tremove: function() {return true},\n\n\tupdate: function() {return true}\n});","import { Mongo } from 'meteor/mongo';\n \nexport const Files = new Mongo.Collection('resources-files');\n\n\nFiles.allow({\n\n  \tinsert: function() {return true},\n\n \tremove: function() {return true},\n\n\tupdate: function() {return true}\n});\n\nif(Meteor.isServer) {\n\n\tMeteor.publish(\"file\", function(fileId) {\n\treturn Files.find({_id:fileId})\n});\n\nMeteor.publish(\"files\", function(spaceId) {\n\treturn Files.find({spaceId: spaceId})\n});\n\nMeteor.publish(\"allFiles\", function() {\n\treturn Files.find({})\n});\n\nMeteor.publish(\"files\", function(spaceId) {\n\tconsole.log(\"tu publies...\");\n\treturn Files.find({spaceId: spaceId})\n});\n\n\tvar fs = Npm.require('fs');\n\tvar rimraf = Npm.require('rimraf'); // Package to delete directories\n\tvar uploadDir = Meteor.settings.uploadDir;\n\n\tMeteor.methods({\n\n\t\tdeleteFile: function(post) {\n\n\t\t\tif (post.type == 'lesson') // Remove directory (each storline lesson is stored in is own directory)\n\t\t\t\trimraf(uploadDir+\"/\"+post.spaceId+\"/\"+post.type+\"/\"+post.fileId, function (err) {console.log(err)});\n\t\t\telse // Remove the file\n    \t\t\tfs.unlinkSync(uploadDir +\"/\"+post.filePath, function (err) {console.log(err)});\n  \t\t}\n\t})\n}","import { Mongo } from 'meteor/mongo';\n \nimport { Authors } from './authors.js';\nimport { Spaces } from './spaces.js';\nimport { Categories } from './categories.js';\nimport { Files } from './files.js';\n\n\nexport const Posts = new Mongo.Collection('resources-posts');\n\n\nPosts.allow({\n\tinsert: function() {return true;},\n\n\tremove: function() {return true;},\n\n\tupdate: function() {return true;}\n});\n\nif(Meteor.isClient) {\n\tCounts = new Mongo.Collection(\"counts\"); // Store post count of a space ; Allow to count them without subscribe to all posts (optimization)\n\tPinnedCounts = new Mongo.Collection(\"pinnedCounts\");\n\tFilesCounts = new Mongo.Collection(\"filesCounts\");\n\tImagesCounts = new Mongo.Collection(\"imagesCounts\");\n\tLiveFeedCounts = new Mongo.Collection(\"liveFeedCounts\");\n}\n\nif(Meteor.isServer) {\n\nMeteor.publish('post', function(postId) {\n\tcheck(postId, String);\n\treturn Posts.find({_id: postId});\n});\n\nMeteor.publish('homePosts', function(spaceId) {\n\tcheck(spaceId, String);\n\treturn Posts.find({spaceId: spaceId, type:\"home\"},{sort: {submitted: 1}});\n});\n\nMeteor.publish('liveFeedPosts', function(spaceId) {\n\tcheck(spaceId, String);\n\treturn Posts.find({spaceId: spaceId, type:\"liveFeed\"},{sort: {submitted: -1}});\n});\n\nMeteor.publish('resourcesPosts', function(spaceId) {\n\tcheck(spaceId, String);\n\treturn Posts.find({spaceId: spaceId, type:\"resources\"});\n});\n\nMeteor.publish('posts', function(filters, skip = 0, limit = 0) {\n\treturn Posts.find(filters, {sort: {submitted:1},skip:skip,limit:limit});\n});\n\n\n\n\tMeteor.publish(\"count-all-live-feed\", function (spaceId) {\n\tvar self = this;\n\tvar liveFeedCounts = 0;\n\tvar initializing = true;\n\n\tvar handle = Posts.find({spaceId: spaceId, type:'liveFeed'}).observeChanges({\n\t\tadded: function (doc, idx) {\n\t\t\tliveFeedCounts++;\n\t\t\tif (!initializing) {\n\t\t\t\tself.changed(\"liveFeedCounts\", spaceId, {count: liveFeedCounts});  // \"counts\" is the published collection name\n\t\t\t}\n\t\t},\n\t\tremoved: function (doc, idx) {\n\t\t\tliveFeedCounts--;\n\t\t\tself.changed(\"liveFeedCounts\", spaceId, {count: liveFeedCounts});  // Same published collection, \"counts\"\n\t\t}\n\t});\n\n\tinitializing = false;\n\n\t// publish the initial count. `observeChanges` guaranteed not to return\n\t// until the initial set of `added` callbacks have run, so the `count`\n\t// variable is up to date.\n\tself.added(\"liveFeedCounts\", spaceId, {count: liveFeedCounts});\n\n\t// and signal that the initial document set is now available on the client\n\tself.ready();\n\n\t// turn off observe when client unsubscribes\n\tself.onStop(function () {\n\t\thandle.stop();\n\t});\n});\n}\n\n// if(Meteor.isServer) {\n\n// \tPosts.before.insert(function (userId, doc) {\n// \t\t// change modified date\n// \t\tSpaces.update(doc.spaceId, {$set: {modified: Date.now()}});\n// \t\tdoc.version =  1;\n// \t\t//doc.modified = Date.now();\n// \t\t/*\n// \t\tvar versionning = {};\n// \t\t_.extend(versionning, doc, {modifiedBy: userId});\n// \t\tMeteor.call('addPostVersion', versionning);\n// \t\t*/\n// \t});\n\n\n// \t// Copy post in postVersion before updated\n// \t// TODO : refactoring\n// \tPosts.before.update(function (userId, doc, fieldNames, modifier, options) {\n\n\n\n// \t\t// var versionning = {};\n// \t\t// _.extend(versionning, doc, {modifiedBy: userId});\n// \t\t// Meteor.call('addPostVersion', versionning);\n\n// \t\t// var newInc = doc.version+1;\n// \t\t// if (!modifier.$set) modifier.$set = {};\n// \t\t// modifier.$set.version = newInc;\n// \t\t// modifier.$set.modified = Date.now();\n// \t});\n\n\n// \tPosts.before.remove(function (userId, doc) { \n\n\n// \t\t// var deletionTime = Date.now();\n\n// \t\t// Meteor.call('tagsEdit', {spaceId: doc.spaceId, newTags: [], oldTags: doc.tags}, function(error) { // Decrement tags nRefs\n// \t\t// \tif (error) {\n// \t\t// \t\tthrowError(error.reason);\n// \t\t// \t}\n//  \t// \t});\n\n// \t\t// var file = Files.findOne({'metadata.postId': doc.fileId}); // Remove file\n// \t\t// if (file){\n// \t\t// \t // TODO : remove file (not only from collection)\n// \t\t// \tFiles.remove(file._id);\n// \t\t// }\n\n// \t\t// Delete the file if exists\n// \t\tvar fileId = doc.fileId;\n// \t\tvar fileExt = doc.fileExt;\n// \t\tif (fileId) {\n// \t\t\tFiles.remove({fileId:fileId});\n// \t\t\tMeteor.call('deleteFile',doc);\n// \t\t}\n\n// \t\tif (doc.type == 'home') { // Update post order\n// \t\t\tvar post = doc;\n\n// \t\t\tvar postsDown = Posts.find({spaceId:doc.spaceId, type:'home', order:{$gt:post.order}}).fetch();\n\n// \t\t\tfor (var i=0; i<postsDown.length; i++) {\n// \t\t\t\tconsole.log(\"id : \"+postsDown[i]._id);\n// \t\t\t\tvar currentPost = postsDown[i];\n// \t\t\t\tPosts.update({_id:currentPost._id},{$set:{order:currentPost.order-1}});\n// \t\t\t}\n// \t\t}\n\n// \t\tif (doc.type == 'liveFeed') {\n// \t\t\tvar author = Authors.findOne({spaceId: doc.spaceId, name: doc.author});\n// \t\t\tAuthors.update(author._id, {$inc: {nRefs: -1}}); // Decrement author nRefs\n\n// \t\t\tif (doc.category) {\n// \t\t\t\tvar category = Categories.findOne({spaceId: doc.spaceId, type:\"liveFeed\", name: doc.category});\n// \t\t\t\tif (category)\n// \t\t\t\t\tCategories.update(category._id, {$inc: {nRefs: -1}}); // Decrement category nRefs\n// \t\t\t}\n// \t\t}\n\n// \t\tif (doc.type == 'resource') {\n// \t\t\tif (doc.category) {\n// \t\t\t\tvar category = Categories.findOne({spaceId: doc.spaceId, type:\"resource\", name: doc.category});\n// \t\t\t\tif (category)\n// \t\t\t\t\tCategories.update(category._id, {$inc: {nRefs: -1}}); // Decrement category nRefs\n// \t\t\t}\n// \t\t}\n// \t\t// // Add post to posts versions\n// \t\t// // TODO : refactoring\n// \t\t// var space = Spaces.findOne(doc.spaceId);\n// \t\t// // var oldPosts = [];\n// \t\t// // if (space.oldPosts !== undefined) {\n// \t\t// // \toldPosts = space.oldPosts;\n// \t\t// // }\n// \t\t// // oldPosts.push(doc._id);\n// \t\t// //Spaces.update(doc.spaceId, {$set: {oldPosts: oldPosts, modified: Date.now()}});\n// \t\t// Spaces.update(doc.spaceId, {$set: {modified: Date.now()}});\n\n// \t\t// doc.version =  doc.version++;\n// \t\t// doc.modified = Date.now();\n// \t\t// var versionning = {};\n// \t\t// _.extend(versionning, doc, {modifiedBy: userId, last: true});\n// \t\t// Meteor.call('addPostVersion', versionning);\n// \t});\n// }\n\nif(Meteor.isServer) {\n\n\tPosts.after.remove(function (userId, doc) { \n\t\t\t\n\t\t\t// Delete the file if exists\n\t\t\tvar fileId = doc.fileId;\n\t\t\tvar fileExt = doc.fileExt;\n\t\t\tif (fileId) {\n\t\t\t\tFiles.remove({fileId:fileId});\n\t\t\t\tMeteor.call('deleteFile',doc);\n\t\t\t}\n\n\t\t\t// Decrease category count\n\t\t\tif (doc.type == 'resource') {\n\t\t\t\tif (doc.category) {\n\t\t\t\t\tvar category = Categories.findOne({spaceId: doc.spaceId, type:\"resource\", name: doc.category});\n\t\t\t\t\tif (category)\n\t\t\t\t\t\tCategories.update(category._id, {$inc: {nRefs: -1}}); // Decrement category nRefs\n\t\t\t\t}\n\t\t\t}\n\t});\n}\n\n\nMeteor.methods({\n\n\taddLikeComment: function(data) {\n\t\tPosts.update({_id:data.currentPostId,\"comments.id\":data.currentCommentId}, {$push: {\"comments.$.likes\": data.author}});\n\t},\n\tremoveLikeComment: function(data) {\n\t\tPosts.update({_id:data.currentPostId,\"comments.id\":data.currentCommentId}, {$pull: {\"comments.$.likes\": data.author}});\n\t},\n\thomePostInsert: function(postAttributes) {\n\t\tcheck(postAttributes.spaceId, String);\n\n\t\t//if (Meteor.settings.public)\n\t\t\t//var postFromCloud = !(Meteor.settings.public.isBox === \"true\"); // Set where post is submitted (box or cloud)\n\n\t\tpost = _.extend(postAttributes, {\n\t\t\tsubmitted: Date.now(),\n\t\t\torder: Posts.find({spaceId: postAttributes.spaceId, type: postAttributes.type}).count(),\n\t\t\t//nb: Posts.find({spaceId: postAttributes.spaceId}).count() + 1,\n\t\t\t//pinned : false,\n\t\t});\n\n\t\tvar space = Spaces.findOne(postAttributes.spaceId);\n\t\tpost._id = Posts.insert(post);\t\t\n\t\treturn post._id;\n\t},\n\tpostInsert: function(postAttributes) {\n\t\tcheck(postAttributes.spaceId, String);\n\n\t\t//if (Meteor.settings.public)\n\t\t\t//var postFromCloud = !(Meteor.settings.public.isBox === \"true\"); // Set where post is submitted (box or cloud)\n\n\t\t// item = Authors.findOne({spaceId: postAttributes.spaceId, name: postAttributes.author});\n\t\t// Authors.update(item, {$inc: {nRefs: 1}});\n\t\t// post = _.extend(postAttributes, {\n\t\t// \tauthorId: Authors.findOne({spaceId: postAttributes.spaceId, name: postAttributes.author})._id,\n\t\t// \tsubmitted: Date.now(),\n\t\t// \tnb: Posts.find({spaceId: postAttributes.spaceId}).count() + 1,\n\t\t// \tpinned : false,\n\t\t// \t// postFromCloud: postFromCloud // Workaround bug sync\n\t\t// });\n\n\t\t// Get client IP address\n\t\tif (Meteor.isServer)\n\t\t\tpost = _.extend(postAttributes, {clientIP: this.connection.clientAddress});\n\n\t\tvar space = Spaces.findOne(postAttributes.spaceId);\n\n\t\tcategory = Categories.findOne({spaceId: postAttributes.spaceId, name: postAttributes.category}); // Increment category nRefs\n\t\tCategories.update(category, {$inc: {nRefs: 1}});\n\n\t\tpost._id = Posts.insert(post);\t\t\n\t\treturn post._id;\n\t}\n});","import { Mongo } from 'meteor/mongo';\n\nimport { Authors } from './authors.js';\nimport { Codes } from './codes.js';\nimport { Posts } from './posts.js';\n\nexport const Spaces = new Mongo.Collection('resources-spaces');\n\n\nSpaces.allow({\n\n\t//update: function(userId, space) { return true},\n\t//remove: function(userId, space) { return true},\n\n\tinsert: function(userId, space) { return ownsDocument(userId, space) || isAdmin(userId); },\n\n\tupdate: function(userId, space) { return ownsDocument(userId, space) || isAdmin(userId); },\n\n\tremove: function(userId, space) { return ownsDocument(userId, space) || isAdmin(userId); }\n});\n\n\nif(Meteor.isServer) {\t\tconsole.log(\"is Server...\");\n\n\n\n// var connection = DDP.connect(\"http://beekee.box:80\");\n// Accounts.connection = connection;\n// Meteor.users = new Mongo.Collection(\"users\", {connection: connection});\n\n\n\n\tMeteor.publish('space', function(spaceId) {\n\t\tconsole.log(\"publication space...\");\n\t\tcheck(spaceId, String);\n\t\treturn Spaces.find({_id: spaceId});\t\n\t});\n\n\tMeteor.publish('allSpaces', function() {\n\treturn Spaces.find({});\n\t});\n\n\tMeteor.publish('allUsers', function() {\n\treturn Meteor.users.find();\n \t});\n\n\tMeteor.publish('publicSpaces', function(userId) {\n\treturn Spaces.find({\"permissions.public\":true});\n\t});\n\n\tMeteor.publish('ownSpaces', function(userId) {\n\t\tconsole.log(\"own space... : \"+Spaces.find());\n\t\treturn Spaces.find({userId:userId});\n\t});\n\n\tMeteor.publish('spacesVisited', function(spacesId) {\n\t\treturn Spaces.find({ \"_id\": { \"$in\": spacesId } });\n\t});\n\t// Spaces.before.update(function (userId, doc, fieldNames, modifier, options) {\n\n\t// \tmodifier.$set = modifier.$set || {};\n\t// \tmodifier.$set.modified = Date.now();\n\n\t// \t// change modified date\n\t// \tdoc.version =  doc.version++;\n\t// \tdoc.modified = Date.now();\n\t// });\n\n\t// Spaces.before.insert(function (userId, doc) {\n\t// \t// change modified date\n\t// \tdoc.submitted =  Date.now();\n\t// });\n\n\n\t// Spaces.before.remove(function (userId, doc) {\n\n\t// \tvar spaceId = doc._id;\n\t// \tPosts.remove({spaceId:spaceId});\n\t// });\n\n\n\tMeteor.methods({\n\n\t\tgetSpaceId: function(spaceCode) {\n\t\t\tif (Spaces.findOne({spaceCode:spaceCode}))\n\t\t\t\treturn Spaces.findOne({spaceCode:spaceCode})._id;\n\t\t\telse\n\t\t\t\treturn null;\n\t\t},\n\t\tupdateCode: function(oldCode, newCode) {\n\t\t\tvar codeId = Codes.findOne({code: oldCode})._id;\n\t\t\tCodes.update(codeId,{code:newCode}, function(error) {\n\t\t\t\tif (error) {\n\t\t\t\t\tconsole.log(\"Error when changing code : \"+error.message);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tconsole.log(\"Code has been changed.\");\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\tdeleteSpace: function(spaceId) {\n\t\t\tSpaces.remove(spaceId);\n\t\t\t//Posts.remove({spaceId:spaceId},{multi:true});\n\t\t},\n\t\tdeleteSpaces: function(userId) {\n\n\t\t\tSpaces.remove({userId:userId});\n\n\t\t},\n\t\tspaceInsert: function(spaceAttributes) {\n\n\t\t\tcheck(spaceAttributes, {\n\t\t\t\t\ttitle: String,\n\t\t\t\t\tlang: String\n\t\t\t});\n\n\t\t\tvar nbOfCodes = Codes.find().count();\n\t\t\tvar prefix = Meteor.settings.public.prefix;\n\t\t\tvar codeLength = 4;\n\n\t\t\tif (nbOfCodes <= 1000)\n\t\t\t\tcodeLength = 2;\n\t\t\telse if (nbOfCodes > 1000 && nbOfCodes <= 100000)\n\t\t\t\tcodeLength = 3;\n\t\t\telse if (nbOfCodes > 100000 && nbOfCodes <= 10000000)\n\t\t\t\tcodeLength = 4;\n\n\t\t\tvar code = prefix + makeCode(codeLength);\n\t\t\twhile (typeof Codes.findOne({code: code}) != 'undefined')\n\t\t\t\tcode = prefix + makeCode(codeLength);\n\n\t\t\tCodes.insert({code:code, userId:Meteor.userId()});\n\n\t\t\tvar userId = Meteor.userId();\n\t\t\tconsole.log(\"user Id : \"+Accounts.userId());\n\t\t\t\t\t\tconsole.log(\"user Id : \"+Meteor.userId());\n\n\t\t\tvar space = _.extend(spaceAttributes, {\n\t\t\t\tuserId: userId,\n\t\t\t\tspaceCode: code,\n\t\t\t\tsubmitted: new Date(),\n\t\t\t\tvisible: true,\n\t\t\t\tcodePanel: true,\n\t\t\t\tcreateUserAllowed:true,\n\t\t\t\tliveFeed:true,\n\t\t\t\tlessons:false,\n\t\t\t\tresources:true,\n\t\t\t\tliveFeedComments:true,\n\t\t\t\tpermissions:{public:false, liveFeedAddPost:true, liveFeedAddCategory:false}\n\t\t\t});\n\n\t\t\tvar spaceId = Spaces.insert(space);\n\n\t\t\tMeteor.call('authorInsert', 'InvitÃ©', spaceId );\n\n\t\t\t// Insert welcome post\n\t\t\tif (spaceAttributes.lang == \"fr-FR\" || spaceAttributes.lang == \"fr\")\n\t\t\t\tPosts.insert({spaceId:spaceId, type:\"home\", order:0, submitted: Date.now(),title: \"Bienvenue dans votre nouvel espace Beekee Live !\", body:\"<p>Beekee Live est l'outil idÃ©al pour soutenir les interactions en temps rÃ©el, pour partager des photos ou des fichiers avec vos Ã©tudiants.</p>\\n<p>Ce message est visible par vos Ã©tudiants : sentez-vous libre de le modifier (ou de le supprimer) pour communiquer avec eux.</p>\"});\n\t\t\telse\n\t\t\t\tPosts.insert({spaceId:spaceId, type:\"home\", order:0, submitted: Date.now(),title: \"Welcome to your new Beekee Live space!\", body:\"<p>Beekee Live is ideal for real-time interactions and to share pictures or files with your learners.</p>\\n<p>This message will be visibile for everyone: feel free to edit (or delete ) it according to your needs.</p>\"});\n\n\t\t\treturn { _id: spaceId };\n\t\t}\n\t});\n}\n\n\nfunction makeCode(length)\n{\n\tvar text = \"\";\n\tvar possible = \"ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz123456789\";\n\n\tfor( var i=0; i < length; i++ )\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\n\t\n\treturn text;\n}","import { Spaces } from '../imports/api/spaces.js';\n\n\n// ###  Create admin user at first start  ###\n\nif (Spaces.find().count() === 0) {\n\tif (Meteor.users.find().count() === 0) {\n\n\t\t// Create the admin role\n\t\tRoles.createRole('admin', {unlessExists: true});\n\n\t\tvar adminPassword = Meteor.settings.adminPassword;\n\n\t\tvar users = [\n\t\t\t{username:\"admin\",roles:['admin']},\n\t\t];\n\n\t\t_.each(users, function (user) {\n\t\t\tvar id;\n\t\t\tid = Accounts.createUser({\n\t\t\t\tusername: user.username,\n\t\t\t\temail: \"admin@beekee.ch\",\n\t\t\t\t//password: adminPassword,\n\t\t\t\tpassword: \"admin\",\n\t\t\t\tprofile:{name:\"Admin\"}\n\t\t\t});\n\n\t\t\tif (user.roles.length > 0) {\n\t\t\t\tRoles.addUsersToRoles(id, user.roles);\n\t\t\t}\n\t\t});\n\t}\n\n\tSpaces.insert({_id:\"efBc3pjC2JidnkLA2\",title:\"Resources\",userId:\"Admin\"});\n\tAccounts.createUser({\n\t\t\t\tusername: \"marc\",\n\t\t\t\temail: \"marc@marc.ch\",\n\t\t\t\t//password: adminPassword,\n\t\t\t\tpassword: \"12345\",\n\t\t\t\tprofile:{name:\"Marc\"}\n\t\t\t});\n}","// check that the userId specified owns the documents\nownsDocument = function(userId, doc) {\n  return doc && doc.userId === userId;\n}\n\n// check that the userId specified is admin\nisAdmin = function(userId) {\n  return Roles.userIsInRole(Meteor.user(), 'admin');\n}","// Meteor.publish('space', function(spaceId) {\n// \tcheck(spaceId, String);\n// \treturn Spaces.find({_id: spaceId});\t\n// });\n\n// Meteor.publish('allSpaces', function() {\n// \treturn Spaces.find({});\n// });\n\n// Meteor.publish('publicSpaces', function(userId) {\n// \treturn Spaces.find({\"permissions.public\":true});\n// });\n\n// Meteor.publish('ownSpaces', function(userId) {\n// \treturn Spaces.find({userId:userId});\n// });\n\n// Meteor.publish('spacesVisited', function(spacesId) {\n// \treturn Spaces.find({ \"_id\": { \"$in\": spacesId } });\n// });\n\n// Meteor.publish('post', function(postId) {\n// \tcheck(postId, String);\n// \treturn Posts.find({_id: postId});\n// });\n\n\n\n\n// Meteor.publish('homePosts', function(spaceId) {\n// \tcheck(spaceId, String);\n// \treturn Posts.find({spaceId: spaceId, type:\"home\"},{sort: {submitted: 1}});\n// });\n\n// Meteor.publish('liveFeedPosts', function(spaceId) {\n// \tcheck(spaceId, String);\n// \treturn Posts.find({spaceId: spaceId, type:\"liveFeed\"},{sort: {submitted: -1}});\n// });\n\n// Meteor.publish('lessonsPosts', function(spaceId) {\n// \tcheck(spaceId, String);\n// \treturn Posts.find({spaceId: spaceId, type:\"lessons\"});\n// });\n\n// Meteor.publish('resourcesPosts', function(spaceId) {\n// \tcheck(spaceId, String);\n// \treturn Posts.find({spaceId: spaceId, type:\"resources\"});\n// });\n\n\n// Meteor.publish('posts', function(filters, skip = 0, limit = 0) {\n// \treturn Posts.find(filters, {sort: {submitted:1},skip:skip,limit:limit});\n// });\n\n\n// // Meteor.publish('posts', function(filters,skip,limit) {\n// // \treturn Posts.find(filters, {sort: {submitted: 1},skip:skip,limit:limit});\n// // });\n\n// Meteor.publish(\"file\", function(fileId) {\n// \treturn Files.find({_id:fileId})\n// });\n\n// Meteor.publish(\"files\", function(spaceId) {\n// \treturn Files.find({spaceId: spaceId})\n// });\n\n// Meteor.publish(\"allFiles\", function() {\n// \treturn Files.find({})\n// });\n\n// Meteor.publish(\"authors\", function(spaceId) {\n// \treturn Authors.find({spaceId: spaceId});\n// });\n\n// Meteor.publish(\"categories\", function(spaceId) {\n// \treturn Categories.find({spaceId: spaceId});\n// });\n\n// Meteor.publish(\"tags\", function(spaceId) {\n// \treturn Tags.find({spaceId: spaceId});\n// });\n\n// Meteor.publish('allUsers', function() {\n// \treturn Meteor.users.find();\n//  })\n\n// Publish the current size of a collection without subscribe to the collection\n// Meteor.publish(\"count-all-live-feed-posts\", function (spaceId) {\n// \tvar self = this;\n// \tvar count = 0;\n// \tvar initializing = true;\n\n// \tvar handle = Posts.find({spaceId: spaceId, type:\"liveFeed\"}).observeChanges({\n// \t\tadded: function (doc, idx) {\n// \t\t\tcount++;\n// \t\t\tif (!initializing) {\n// \t\t\t\tself.changed(\"counts\", spaceId, {count: count});  // \"counts\" is the published collection name\n// \t\t\t}\n// \t\t},\n// \t\tremoved: function (doc, idx) {\n// \t\t\tcount--;\n// \t\t\tself.changed(\"counts\", spaceId, {count: count});  // Same published collection, \"counts\"\n// \t\t}\n// \t});\n\n// \tinitializing = false;\n\n// \t// publish the initial count. `observeChanges` guaranteed not to return\n// \t// until the initial set of `added` callbacks have run, so the `count`\n// \t// variable is up to date.\n// \tself.added(\"counts\", spaceId, {count: count});\n\n// \t// and signal that the initial document set is now available on the client\n// \tself.ready();\n\n// \t// turn off observe when client unsubscribes\n// \tself.onStop(function () {\n// \t\thandle.stop();\n// \t});\n// });\n\n\n// Meteor.publish(\"count-all-pinned\", function (spaceId) {\n// \tvar self = this;\n// \tvar pinnedCounts = 0;\n// \tvar initializing = true;\n\n// \tvar handle = Posts.find({spaceId: spaceId, pinned:true}).observeChanges({\n// \t\tadded: function (doc, idx) {\n// \t\t\tpinnedCounts++;\n// \t\t\tif (!initializing) {\n// \t\t\t\tself.changed(\"pinnedCounts\", spaceId, {count: pinnedCounts});  // \"counts\" is the published collection name\n// \t\t\t}\n// \t\t},\n// \t\tremoved: function (doc, idx) {\n// \t\t\tpinnedCounts--;\n// \t\t\tself.changed(\"pinnedCounts\", spaceId, {count: pinnedCounts});  // Same published collection, \"counts\"\n// \t\t}\n// \t});\n\n// \tinitializing = false;\n\n// \t// publish the initial count. `observeChanges` guaranteed not to return\n// \t// until the initial set of `added` callbacks have run, so the `count`\n// \t// variable is up to date.\n// \tself.added(\"pinnedCounts\", spaceId, {count: pinnedCounts});\n\n// \t// and signal that the initial document set is now available on the client\n// \tself.ready();\n\n// \t// turn off observe when client unsubscribes\n// \tself.onStop(function () {\n// \t\thandle.stop();\n// \t});\n// });\n\n\n// Meteor.publish(\"count-all-files\", function (spaceId) {\n// \tvar self = this;\n// \tvar filesCounts = 0;\n// \tvar initializing = true;\n\n// \t//var handle = Posts.find({spaceId: spaceId, $or : [{fileExt:\"txt\"},{fileExt:\"rtf\"},{fileExt:\"pdf\"},{fileExt:\"zip\"}]}).observeChanges({\n\n// \tvar handle = Posts.find({spaceId: spaceId, $and : [{fileId:{$exists:true} },{fileId:{$ne:false} },{fileExt:{$nin : [\"jpg\",\"jpeg\",\"png\",\"gif\"]}}]}).observeChanges({\n// \t\tadded: function (doc, idx) {\n// \t\t\tfilesCounts++;\n// \t\t\tif (!initializing) {\n// \t\t\t\tself.changed(\"filesCounts\", spaceId, {count: filesCounts});  // \"counts\" is the published collection name\n// \t\t\t}\n// \t\t},\n// \t\tremoved: function (doc, idx) {\n// \t\t\tfilesCounts--;\n// \t\t\tself.changed(\"filesCounts\", spaceId, {count: filesCounts});  // Same published collection, \"counts\"\n// \t\t}\n// \t});\n\n// \tinitializing = false;\n\n// \t// publish the initial count. `observeChanges` guaranteed not to return\n// \t// until the initial set of `added` callbacks have run, so the `count`\n// \t// variable is up to date.\n// \tself.added(\"filesCounts\", spaceId, {count: filesCounts});\n\n// \t// and signal that the initial document set is now available on the client\n// \tself.ready();\n\n// \t// turn off observe when client unsubscribes\n// \tself.onStop(function () {\n// \t\thandle.stop();\n// \t});\n// });\n\n\n// Meteor.publish(\"count-all-images\", function (spaceId) {\n// \tvar self = this;\n// \tvar imagesCounts = 0;\n// \tvar initializing = true;\n\n// \tvar handle = Posts.find({spaceId: spaceId, $or : [{fileExt:\"jpg\"},{fileExt:\"jpeg\"},{fileExt:\"gif\"},{fileExt:\"png\"}]}).observeChanges({\n// \t\tadded: function (doc, idx) {\n// \t\t\timagesCounts++;\n// \t\t\tif (!initializing) {\n// \t\t\t\tself.changed(\"imagesCounts\", spaceId, {count: imagesCounts});  // \"counts\" is the published collection name\n// \t\t\t}\n// \t\t},\n// \t\tremoved: function (doc, idx) {\n// \t\t\timagesCounts--;\n// \t\t\tself.changed(\"imagesCounts\", spaceId, {count: imagesCounts});  // Same published collection, \"counts\"\n// \t\t}\n// \t});\n\n// \tinitializing = false;\n\n// \t// publish the initial count. `observeChanges` guaranteed not to return\n// \t// until the initial set of `added` callbacks have run, so the `count`\n// \t// variable is up to date.\n// \tself.added(\"imagesCounts\", spaceId, {count: imagesCounts});\n\n// \t// and signal that the initial document set is now available on the client\n// \tself.ready();\n\n// \t// turn off observe when client unsubscribes\n// \tself.onStop(function () {\n// \t\thandle.stop();\n// \t});\n// });\n\n\n\n// Meteor.publish(\"count-all-live-feed\", function (spaceId) {\n// \tvar self = this;\n// \tvar liveFeedCounts = 0;\n// \tvar initializing = true;\n\n// \tvar handle = Posts.find({spaceId: spaceId, type:'liveFeed'}).observeChanges({\n// \t\tadded: function (doc, idx) {\n// \t\t\tliveFeedCounts++;\n// \t\t\tif (!initializing) {\n// \t\t\t\tself.changed(\"liveFeedCounts\", spaceId, {count: liveFeedCounts});  // \"counts\" is the published collection name\n// \t\t\t}\n// \t\t},\n// \t\tremoved: function (doc, idx) {\n// \t\t\tliveFeedCounts--;\n// \t\t\tself.changed(\"liveFeedCounts\", spaceId, {count: liveFeedCounts});  // Same published collection, \"counts\"\n// \t\t}\n// \t});\n\n// \tinitializing = false;\n\n// \t// publish the initial count. `observeChanges` guaranteed not to return\n// \t// until the initial set of `added` callbacks have run, so the `count`\n// \t// variable is up to date.\n// \tself.added(\"liveFeedCounts\", spaceId, {count: liveFeedCounts});\n\n// \t// and signal that the initial document set is now available on the client\n// \tself.ready();\n\n// \t// turn off observe when client unsubscribes\n// \tself.onStop(function () {\n// \t\thandle.stop();\n// \t});\n// });","import { Files } from '../imports/api/files.js';\n\n// Upload files with tomitrescak:meteor-uploads\n\nMeteor.startup(function () {\n\n\tUploadServer.init({\n\t\ttmpDir: Meteor.settings.uploadDir+'/tmp',\n\t\tuploadDir: Meteor.settings.uploadDir,\n\t\tcheckCreateDirectories: true,\n\t\tgetDirectory: function(fileInfo, formData) {\n\n\t\t\tvar spaceId = formData.spaceId;\n\t\t\tfileInfo.spaceId = spaceId;\n\n\t\t\tvar newID = new Mongo.ObjectID(); // Manually generate a new Mongo id\n\t\t\tvar fileId = newID._str;\n\t\t\tfileInfo.fileId = fileId;\n\n\t\t\tif (formData.type == 'liveFeed') {\n\t\t\t\tconsole.log(\"Uploading a liveFeed file...\");\n\t\t\t\treturn '/'+spaceId+'/liveFeed/';\n\t\t\t}\n\t\t\telse if (formData.type == 'resource') {\n\t\t\t\tconsole.log(\"Uploading a resource...\");\n\t\t\t\treturn '/'+spaceId+'/resource/';\n\t\t\t}\n\t\t\telse if (formData.type == 'lesson') {\n\t\t\t\tconsole.log(\"Uploading lesson file...\");\n\t\t\t\treturn '/'+spaceId+'/lesson/'+fileId;\n\t\t\t}\n\t\t\t// TODO : add more security\n\t\t\telse if (formData.type == 'update') {\n\t\t\t\tconsole.log(\"Uploading update file\");\n\t\t\t\treturn '/updates';\n\t\t\t}\n\t\t\treturn '/';\n\t\t\t\n\t\t},\n\t\tfinished: function(fileInfo, formFields, formData) {\n\n\t\t\tvar fileName = fileInfo.name.substr(0, fileInfo.name.lastIndexOf('.')) || fileInfo.name;\n\t\t\tfileInfo.fileName = fileName;\n\t\t\t//fileInfo.fileName = unescape(fileName); // Check why we unescape file name in getFileName method\n\n\t\t\tvar fileExt = fileInfo.name.substr(fileInfo.name.lastIndexOf('.')+1).toLowerCase();\n\t\t\tfileInfo.fileExt = fileExt;\n\n\t\t\tif (formFields.type == 'liveFeed' || formFields.type == 'resource') {\n\t\t\t\tif (fileExt == \"jpg\" || fileExt == \"jpeg\" || fileExt == \"png\") {\n\t\t\t\t\t// Resize and auto-orient uploaded images with GraphicMagicks\n\t\t\t\t\tgm(Meteor.settings.uploadDir+fileInfo.path).autoOrient().resize('1200','1200').write(Meteor.settings.uploadDir+fileInfo.path,Meteor.bindEnvironment(function (error, result) {\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\tconsole.log(\"Error when resizing :\"+error);\n\t\t\t\t\t\t\tvar errorMessage = \"An error has occured.\"\n\t\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, error:errorMessage});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, fileName:fileInfo.fileName, fileExt:fileExt, filePath: fileInfo.path});\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, fileName:fileInfo.fileName, fileExt:fileExt, filePath: fileInfo.path});\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (formFields.type == 'lesson') {\n\t\t\t\tcmd = Meteor.wrapAsync(exec);\n\t\t\t\tres = cmd(\"unzip '\"+Meteor.settings.uploadDir+fileInfo.path+\"' -d '\"+Meteor.settings.uploadDir+\"/\"+fileInfo.spaceId+\"/lesson/\"+fileInfo.fileId+\"'\", {maxBuffer : 1024 * 1024 * 64}, function(error,result){\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\tconsole.log(\"Error when uploading a lesson : \"+error);\n\t\t\t\t\t\tvar errorMessage = \"An error has occured.\"\n\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, error:errorMessage});\n\t\t\t\t\t} else {\t\t\t\t\n\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, fileName:fileInfo.fileName, fileExt:fileExt, filePath: fileInfo.path})\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tres2 = cmd(\"rm '\"+Meteor.settings.uploadDir+fileInfo.path+\"'\");\n\t\t\t}\n\t\t\telse if (formFields.type == 'update') {\n\t\t\t\tcmd = Meteor.wrapAsync(exec);\t\n\t\t\t\tres = cmd(\"tar zxvf '\"+Meteor.settings.uploadDir+fileInfo.path+\"' -C \"+Meteor.settings.updateDir, {maxBuffer : 1024 * 1024 * 64}, function(error,result){\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\tconsole.log(\"Error when uploading an update : \"+error);\n\t\t\t\t\t\tvar errorMessage = \"An error has occured.\"\n\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, error:errorMessage});\n\t\t\t\t\t} else {\t\t\t\t\n\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, fileName:fileInfo.fileName, fileExt:fileExt, filePath: fileInfo.path})\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tres2 = cmd(\"rm '\"+Meteor.settings.uploadDir+fileInfo.path+\"'\", {maxBuffer : 1024 * 1024 * 64},);\n\t\t\t}\n\t\t},\n\t\tgetFileName: function(fileInfo, formFields, formData) { \n\n\t\t\tvar fileName = fileInfo.name;\t\n\n\t\t\t//fileName = escape(fileName);\n\t\t\t// The file name is used to generate the file path, so we escape unicode characters\n\t\t\t// and then we unescape it in finished method to save it in human-readable text\n\n\t\t\treturn fileName;\n\t\t\t// var fileExt = fileInfo.name.substr(fileInfo.name.lastIndexOf('.')+1).toLowerCase();\n\n\t\t\t// // If file is an image, set a random name\n\t\t\t// if (fileExt == \"jpg\" || fileExt == \"jpeg\" || fileExt == \"png\") {\n\t\t\t// \tvar newName = Random.id() + '.' + fileExt;\n\t\t\t// \treturn newName;\n\t\t\t// }\n\t\t\t// else {\n\t\t\t// \tvar fileName = fileInfo.name;\t\n\n\t\t\t// \tfileName = encodeURIComponent(fileName);\n\n\t\t\t// \treturn fileName;\n\t\t\t// }\n\t\t},\n\t\tcacheTime: 0,\n  \t});\n});","import { Meteor } from 'meteor/meteor';\n\nimport '../server/fixtures.js';\nimport '../server/publications.js';\nimport '../server/uploads.js';\nimport '../server/permissions.js';\nimport '../lib/app_loader.js';\n\n\nMeteor.startup(() => {\n\n\tMeteor.publish(null, function () {\n\t    return Meteor.roleAssignment.find();\n\n});\n  // code to run on server at startup\n\n\t// Connect Accounts to remote App\n\t//Meteor.connection = DDP.connect('http://beekee.box:80');\n\t// Remote = DDP.connect('http://beekee.box:80');\n\t// Accounts.connection = Remote;\n\t// Meteor.users = new Mongo.Collection('users', Remote);\n\t//  Accounts.connection.subscribe('users');\n// __meteor_runtime_config__.ACCOUNTS_CONNECTION_URL = 'http://beekee.box:80';\n\n// var connection = DDP.connect(\"http://beekee.box:80\");\n// Accounts.connection = connection;\n// Meteor.users = new Mongo.Collection(\"users\", {connection: connection});\n\n});\n"]}